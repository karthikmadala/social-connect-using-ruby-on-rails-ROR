<h1>News Feed</h1>

<%= form_with model: @post, local: true do |form| %>
  <div class="d-flex align-items-center mb-3">
    <% if current_user.avatar.attached? %>
      <%= image_tag current_user.avatar, class: "rounded-circle me-2", width: 50, height: 50 %>
    <% else %>
      <%= image_tag "default_avatar.png", class: "rounded-circle me-2", width: 50, height: 50 %>
    <% end %>
    
    <div class="w-100">
      <%= form.text_area :content, class: "form-control", placeholder: "What's on your mind?", rows: 3 %>
    </div>
  </div>

  <div class="mb-3">
  <%= form.file_field :photos, multiple: true, accept: "image/*", class: "form-control", id: "photo-upload" %>
</div>

<!-- Preview area -->
<div id="image-preview" class="d-flex flex-wrap mt-2"></div>


  <%= form.submit "Post", class: "btn btn-primary w-100" %>
<% end %>

<hr>

<ul class="list-group">
  <% @posts.each do |post| %>
    <li class="list-group-item">
      <div class="d-flex align-items-center mb-2">
        <% if post.user.avatar.attached? %>
          <%= image_tag post.user.avatar, class: "rounded-circle me-2", width: 40, height: 40 %>
        <% else %>
          <%= image_tag "default_avatar.png", class: "rounded-circle me-2", width: 40, height: 40 %>
        <% end %>
        
        <div>
          <strong><%= post.user.email %></strong><br>
          <small class="text-muted"><%= time_ago_in_words(post.created_at) %> ago</small>
        </div>
      </div>

      <p><%= post.content %></p>

      <% if post.photos.attached? %>
        <div class="d-flex flex-wrap">
          <% post.photos.each do |photo| %>
            <%= image_tag photo, class: "rounded me-2", width: 150, height: 150 %>
          <% end %>
        </div>
      <% end %>

      <div class="mt-2">
        <%= button_to "👍 Like (#{post.likes.count})", post_likes_path(post_id: post.id), method: :post, class: "btn btn-outline-primary btn-sm" %>
        <%= link_to "💬 Comment", "#comment-section-#{post.id}", class: "btn btn-outline-secondary btn-sm" %>
      </div>

      <div id="comment-section-<%= post.id %>" class="mt-3">
        <% post.comments.each do |comment| %>
          <div class="d-flex align-items-center">
            <% if comment.user.avatar.attached? %>
              <%= image_tag comment.user.avatar, class: "rounded-circle me-2", width: 30, height: 30 %>
            <% else %>
              <%= image_tag "default_avatar.png", class: "rounded-circle me-2", width: 30, height: 30 %>
            <% end %>
            <strong><%= comment.user.email %>:</strong> <%= comment.content %>
          </div>
        <% end %>

        <%= form_with model: [post, Comment.new], local: true do |form| %>
          <div class="d-flex mt-2">
            <%= form.text_field :content, class: "form-control me-2", placeholder: "Write a comment..." %>
            <%= form.submit "Post", class: "btn btn-primary btn-sm" %>
          </div>
        <% end %>
      </div>
    </li>
  <% end %>
</ul>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const fileInput = document.getElementById("photo-upload");
  const previewContainer = document.getElementById("image-preview");

  fileInput.addEventListener("change", function(event) {
    previewContainer.innerHTML = ""; // Clear previous previews
    const files = event.target.files;

    Array.from(files).forEach(file => {
      if (file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement("img");
          img.src = e.target.result;
          img.classList.add("rounded", "me-2", "mb-2");
          img.style.width = "100px";
          img.style.height = "100px";
          img.style.objectFit = "cover";
          previewContainer.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    });
  });
});
</script>
